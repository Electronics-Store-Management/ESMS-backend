<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StatisticService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">esms</a> &gt; <a href="index.source.html" class="el_package">com.penguin.esms.components.statistic</a> &gt; <span class="el_source">StatisticService.java</span></div><h1>StatisticService.java</h1><pre class="source lang-java linenums">package com.penguin.esms.components.statistic;

import com.amazonaws.services.dynamodbv2.xspec.S;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.penguin.esms.components.category.CategoryEntity;
import com.penguin.esms.components.importBill.ImportBillEntity;
import com.penguin.esms.components.importBill.ImportBillService;
import com.penguin.esms.components.importProduct.ImportProductEntity;
import com.penguin.esms.components.saleBill.SaleBillEntity;
import com.penguin.esms.components.saleBill.SaleBillRepo;
import com.penguin.esms.components.saleBill.SaleBillService;
import com.penguin.esms.components.saleProduct.SaleProductEntity;
import com.penguin.esms.components.saleProduct.SaleProductRepo;
import com.penguin.esms.components.saleProduct.SaleProductService;
import com.penguin.esms.components.statistic.dto.StatisticDTO;
import com.penguin.esms.envers.AuditEnversInfo;
import com.penguin.esms.utils.TimeUtils;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;

import java.util.*;

@Service
<span class="fc" id="L28">@RequiredArgsConstructor</span>
public class StatisticService {
    private final StatisticRepository repo;
    private final SaleBillService saleBillService;
    private final ImportBillService importBillService;
    private final SaleProductService saleProductService;
    private final SaleBillRepo saleBillRepo;
    private final SaleProductRepo saleProductRepo;

    public StatisticEntity add(String name, Object object) throws JsonProcessingException {
<span class="nc" id="L38">        ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="nc" id="L39">        String jsonString = objectMapper.writeValueAsString(object);</span>
<span class="nc" id="L40">        StatisticEntity entity = new StatisticEntity(name, jsonString, new Date(), TimeUtils.getDay(new Date()));</span>
<span class="nc" id="L41">        return repo.save(entity);</span>
    }

    public StatisticEntity getByName(String name) {
<span class="nc" id="L45">        return repo.findByName(name).get();</span>
    }

    public StatisticDTO getRevenuePeriod(Date start, Date end) throws JsonProcessingException {
<span class="nc" id="L49">        StatisticDTO dto = new StatisticDTO(null, 0l, 0l, 0);</span>
<span class="nc" id="L50">        Map&lt;String, StatisticDTO&gt; map = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">        for (Long i = TimeUtils.getDay(start); i &lt; TimeUtils.getDay(end); i++) {</span>
<span class="nc" id="L52">            Optional&lt;StatisticEntity&gt; statisticEntityOptional = repo.findByName(&quot;revenueByPeriod&quot; + (i - 1) + i);</span>
<span class="nc" id="L53">            ObjectMapper objectMapper = new ObjectMapper();</span>
            try {
<span class="nc" id="L55">                StatisticDTO statistic = objectMapper.readValue(statisticEntityOptional.get().getData(), StatisticDTO.class);</span>
<span class="nc" id="L56">                dto.setQuantity(dto.getQuantity() + statistic.getQuantity());</span>
<span class="nc" id="L57">                dto.setRevenue(dto.getRevenue() + statistic.getRevenue());</span>
<span class="nc" id="L58">            }catch (NoSuchElementException s){}</span>

        }
<span class="nc" id="L61">        return dto;</span>
    }

    public StatisticDTO getRevenueDate(Date date) throws JsonProcessingException {
<span class="nc" id="L65">        Long i = TimeUtils.getDay(date);</span>
<span class="nc" id="L66">        StatisticDTO dto = new StatisticDTO(null, 0l, 0l, 0);</span>
<span class="nc" id="L67">        Map&lt;String, StatisticDTO&gt; map = new HashMap&lt;&gt;();</span>
<span class="nc" id="L68">        Optional&lt;StatisticEntity&gt; statisticEntityOptional = repo.findByName(&quot;revenueByDate&quot; + i);</span>
<span class="nc" id="L69">        ObjectMapper objectMapper = new ObjectMapper();</span>
        try {
<span class="nc" id="L71">            StatisticDTO statistic = objectMapper.readValue(statisticEntityOptional.get().getData(), StatisticDTO.class);</span>
<span class="nc" id="L72">            dto.setQuantity(dto.getQuantity() + statistic.getQuantity());</span>
<span class="nc" id="L73">            dto.setRevenue(dto.getRevenue() + statistic.getRevenue());</span>
<span class="nc" id="L74">        } catch (NoSuchElementException s) {</span>
<span class="nc" id="L75">        }</span>

<span class="nc" id="L77">        return dto;</span>
    }
//    @Bean
//    @Scheduled(cron = &quot;39 1 * * * * &quot;, zone = &quot;Asia/Ho_Chi_Minh&quot;)
//    public void scheduledRevenueByPeriod() throws JsonProcessingException {
//        System.out.println(&quot;loz que&quot;);
//        Double previousDateTime = ((double) (TimeUtils.getDay(new Date()) - 1)) - 7.0 / 24;
//        Date previousDateStart = new Date((long) (previousDateTime * 86400000));
//        Date previousDateEnd = new Date((long) ((previousDateTime + 1) * 86400000));
//        revenueByPeriod(previousDateStart, previousDateEnd);
//    }
    public StatisticDTO revenueByPeriod(Date start, Date end) throws JsonProcessingException {
<span class="nc" id="L89">        StatisticDTO dto = new StatisticDTO(null, 0l, 0l, 0);</span>
<span class="nc" id="L90">        Map&lt;String, StatisticDTO&gt; map = new HashMap&lt;&gt;();</span>
<span class="nc" id="L91">        List&lt;AuditEnversInfo&gt; auditEnversInfoList = (List&lt;AuditEnversInfo&gt;) saleBillService.getAllRevisions(start, end);</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">        for (AuditEnversInfo i : auditEnversInfoList) {</span>
<span class="nc" id="L93">            SaleBillEntity saleBill = (SaleBillEntity) i.getRevision();</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">            for (SaleProductEntity t : (List&lt;SaleProductEntity&gt;) saleBill.getSaleProducts()) {</span>
                try {
<span class="nc" id="L96">                    dto.setQuantity(dto.getQuantity() + t.getQuantity());</span>
<span class="nc" id="L97">                    dto.setRevenue(dto.getRevenue() + t.getPrice() * t.getQuantity());</span>
<span class="nc" id="L98">                } catch (NullPointerException e) {</span>
<span class="nc" id="L99">                }</span>
<span class="nc" id="L100">            }</span>
<span class="nc" id="L101">        }</span>
<span class="nc" id="L102">        add(&quot;revenueByPeriod&quot; + TimeUtils.getDay(start) + TimeUtils.getDay(end), dto);</span>
<span class="nc" id="L103">        return dto;</span>
    }

    public List&lt;?&gt; revenueByCategory(Date start, Date end) throws JsonProcessingException {
<span class="nc" id="L107">        StatisticDTO dto = new StatisticDTO();</span>
<span class="nc" id="L108">        Map&lt;String, StatisticDTO&gt; map = new HashMap&lt;&gt;();</span>
<span class="nc" id="L109">        List&lt;AuditEnversInfo&gt; auditEnversInfoList = (List&lt;AuditEnversInfo&gt;) saleBillService.getAllRevisions(start, end);</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">        for (AuditEnversInfo i : auditEnversInfoList) {</span>
<span class="nc" id="L111">            SaleBillEntity saleBill = (SaleBillEntity) i.getRevision();</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">            for (SaleProductEntity t : saleBill.getSaleProducts()) {</span>
                try {
<span class="nc" id="L114">                    CategoryEntity category = t.getProduct().getCategory();</span>
<span class="nc" id="L115">                    dto = map.get(category.getName());</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">                    if (dto == null) {</span>
<span class="nc" id="L117">                        dto = new StatisticDTO();</span>
<span class="nc" id="L118">                        dto.setName(category.getName());</span>
<span class="nc" id="L119">                        dto.setRevenue(0L);</span>
<span class="nc" id="L120">                        dto.setQuantity(0);</span>
                    }
<span class="nc" id="L122">                    dto.setQuantity(dto.getQuantity() + t.getQuantity());</span>
<span class="nc" id="L123">                    dto.setRevenue(dto.getRevenue() + t.getQuantity() * t.getPrice());</span>
<span class="nc" id="L124">                    map.put(category.getName(), dto);</span>
<span class="nc" id="L125">                } catch (NullPointerException e) {</span>
<span class="nc" id="L126">                }</span>
<span class="nc" id="L127">            }</span>
<span class="nc" id="L128">        }</span>
<span class="nc" id="L129">        add(&quot;revenueByCategory&quot; + TimeUtils.getDay(start) + TimeUtils.getDay(end), Arrays.asList(map.entrySet().toArray()));</span>
<span class="nc" id="L130">        return Arrays.asList(map.entrySet().toArray());</span>
    }

    public StatisticDTO costByPeriod(Date start, Date end) throws JsonProcessingException {
<span class="nc" id="L134">        StatisticDTO dto = new StatisticDTO(null, 0l, 0l, 0);</span>
<span class="nc" id="L135">        Map&lt;String, StatisticDTO&gt; map = new HashMap&lt;&gt;();</span>
<span class="nc" id="L136">        List&lt;AuditEnversInfo&gt; auditEnversInfoList = (List&lt;AuditEnversInfo&gt;) importBillService.getAllRevisions(start, end);</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">        for (AuditEnversInfo i : auditEnversInfoList) {</span>
<span class="nc" id="L138">            ImportBillEntity importBill = (ImportBillEntity) i.getRevision();</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">            for (ImportProductEntity t : (List&lt;ImportProductEntity&gt;) importBill.getImportProducts()) {</span>
                try {
<span class="nc" id="L141">                    dto.setQuantity(dto.getQuantity() + t.getQuantity());</span>
<span class="nc" id="L142">                    dto.setCost(dto.getCost() + t.getPrice() * t.getQuantity());</span>
<span class="nc" id="L143">                } catch (NullPointerException e) {</span>
<span class="nc" id="L144">                }</span>
<span class="nc" id="L145">            }</span>
<span class="nc" id="L146">        }</span>
<span class="nc" id="L147">        add(&quot;costByPeriod&quot; + TimeUtils.getDay(start) + TimeUtils.getDay(end), dto);</span>
<span class="nc" id="L148">        return dto;</span>
    }

    public StatisticDTO getCostPeriod(Date start, Date end) throws JsonProcessingException {
<span class="nc" id="L152">        StatisticDTO dto = new StatisticDTO(null, 0l, 0l, 0);</span>
<span class="nc" id="L153">        Map&lt;String, StatisticDTO&gt; map = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">        for (Long i = TimeUtils.getDay(start); i &lt; TimeUtils.getDay(end); i++) {</span>
<span class="nc" id="L155">            Optional&lt;StatisticEntity&gt; statisticEntityOptional = repo.findByName(&quot;costByPeriod&quot; + (i - 1) + i);</span>
<span class="nc" id="L156">            ObjectMapper objectMapper = new ObjectMapper();</span>
            try {
<span class="nc" id="L158">                StatisticDTO statistic = objectMapper.readValue(statisticEntityOptional.get().getData(), StatisticDTO.class);</span>
<span class="nc" id="L159">                dto.setQuantity(dto.getQuantity() + statistic.getQuantity());</span>
<span class="nc" id="L160">                dto.setRevenue(dto.getCost() + statistic.getCost());</span>
<span class="nc" id="L161">            } catch (NoSuchElementException s) {</span>
<span class="nc" id="L162">            }</span>
        }
<span class="nc" id="L164">        return dto;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>