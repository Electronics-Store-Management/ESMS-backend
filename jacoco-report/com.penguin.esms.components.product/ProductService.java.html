<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProductService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">esms</a> &gt; <a href="index.source.html" class="el_package">com.penguin.esms.components.product</a> &gt; <span class="el_source">ProductService.java</span></div><h1>ProductService.java</h1><pre class="source lang-java linenums">package com.penguin.esms.components.product;

import com.penguin.esms.components.category.CategoryEntity;
import com.penguin.esms.components.category.CategoryRepo;
import com.penguin.esms.components.product.dto.ProductDTO;
import com.penguin.esms.components.supplier.SupplierEntity;
import com.penguin.esms.components.supplier.SupplierRepo;
import com.penguin.esms.entity.Error;
import com.penguin.esms.envers.AuditEnversInfo;
import com.penguin.esms.envers.AuditEnversInfoRepo;
import com.penguin.esms.mapper.DTOtoEntityMapper;
import com.penguin.esms.services.AmazonS3Service;
import jakarta.persistence.EntityManager;
import jakarta.persistence.PersistenceContext;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.hibernate.envers.AuditReader;
import org.hibernate.envers.AuditReaderFactory;
import org.hibernate.envers.query.AuditEntity;
import org.hibernate.envers.query.AuditQuery;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.server.ResponseStatusException;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

@Service
//@Getter
//@Setter
<span class="fc" id="L34">@RequiredArgsConstructor</span>
public class ProductService {
    private final ProductRepo productRepo;
    private final CategoryRepo categoryRepo;
    private final SupplierRepo supplierRepo;
    private final DTOtoEntityMapper mapper;
    private final AmazonS3Service amazonS3Service;
    @PersistenceContext
    private final EntityManager entityManager;
    private final AuditEnversInfoRepo auditEnversInfoRepo;

    public List&lt;ProductEntity&gt; findRelatedCategory(String name, String categoryName) {
<span class="pc bpc" id="L46" title="1 of 4 branches missed.">        if (categoryName != null &amp;&amp; !categoryName.isEmpty()) {</span>
<span class="fc" id="L47">            Optional&lt;CategoryEntity&gt; optionalCategory = categoryRepo.findByName(categoryName);</span>
<span class="fc bfc" id="L48" title="All 2 branches covered.">            if (optionalCategory.isEmpty())</span>
<span class="fc" id="L49">                throw new ResponseStatusException(HttpStatus.NOT_FOUND, new Error(&quot;category not found&quot;).toString());</span>
<span class="fc bfc" id="L50" title="All 2 branches covered.">            if (optionalCategory.get().getIsStopped() == true)</span>
<span class="fc" id="L51">                throw new ResponseStatusException(</span>
                        HttpStatus.BAD_REQUEST, &quot;Category has been discontinued &quot;);
<span class="fc" id="L53">            Optional&lt;ProductEntity&gt; productEntityOptional = productRepo.findByName(name);</span>
<span class="pc bpc" id="L54" title="1 of 2 branches missed.">            if (productEntityOptional.isEmpty())</span>
<span class="nc" id="L55">                throw new ResponseStatusException(HttpStatus.NOT_FOUND, new Error(&quot;product not found&quot;).toString());</span>
<span class="fc" id="L56">            return productRepo.findByNameContainingIgnoreCaseAndCategoryAndIsStopped(name, optionalCategory.get(), false);</span>
<span class="pc bpc" id="L57" title="4 of 6 branches missed.">        } else if (categoryName == null || categoryName.isEmpty() ||  name == null) {</span>
<span class="fc" id="L58">            throw new ResponseStatusException(</span>
                    HttpStatus.NOT_FOUND, &quot;null &quot;);
        }
<span class="nc" id="L61">        return null;</span>

    }
    public List&lt;ProductEntity&gt; findDiscontinuedRelatedCategory(String name, String categoryName) {
<span class="pc bpc" id="L65" title="1 of 4 branches missed.">        if (categoryName != null &amp;&amp; !categoryName.isEmpty()) {</span>
<span class="fc" id="L66">            Optional&lt;CategoryEntity&gt; optionalCategory = categoryRepo.findByName(categoryName);</span>
<span class="fc bfc" id="L67" title="All 2 branches covered.">            if (optionalCategory.isEmpty())</span>
<span class="fc" id="L68">                throw new ResponseStatusException(HttpStatus.NOT_FOUND, new Error(&quot;category not found&quot;).toString());</span>
<span class="fc bfc" id="L69" title="All 2 branches covered.">            if (optionalCategory.get().getIsStopped() == true)</span>
<span class="fc" id="L70">                throw new ResponseStatusException(</span>
                        HttpStatus.BAD_REQUEST, &quot;Category has been discontinued &quot;);
<span class="fc" id="L72">            Optional&lt;ProductEntity&gt; productEntityOptional = productRepo.findByName(name);</span>
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">            if (productEntityOptional.isEmpty())</span>
<span class="nc" id="L74">                throw new ResponseStatusException(HttpStatus.NOT_FOUND, new Error(&quot;product not found&quot;).toString());</span>
<span class="fc" id="L75">            return productRepo.findByNameContainingIgnoreCaseAndCategoryAndIsStopped(name, optionalCategory.get(), true);</span>
<span class="pc bpc" id="L76" title="4 of 6 branches missed.">        } else if (categoryName == null || categoryName.isEmpty() ||  name == null) {</span>
<span class="fc" id="L77">            throw new ResponseStatusException(</span>
                    HttpStatus.NOT_FOUND, &quot;null &quot;);
        }
<span class="nc" id="L80">        return null;</span>
    }

    public ProductEntity getProductById(String productId) {
<span class="fc" id="L84">        Optional&lt;ProductEntity&gt; product = productRepo.findById(productId);</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">        if (product.isEmpty()) {</span>
<span class="fc" id="L86">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, new Error(&quot;Product not found&quot;).toString());</span>
        }
<span class="fc bfc" id="L88" title="All 2 branches covered.">        if (product.get().getIsStopped() == true)</span>
<span class="fc" id="L89">            throw new ResponseStatusException(</span>
                    HttpStatus.BAD_REQUEST, &quot;Product has been discontinued &quot;);
<span class="fc" id="L91">        return product.get();</span>
    }

    public ProductEntity add(ProductDTO productDTO) {
<span class="fc" id="L95">        Optional&lt;ProductEntity&gt; productOpt = productRepo.findByName(productDTO.getName());</span>
//        if (productOpt.isPresent()) {
//            if (productOpt.get().getIsStopped() == true)
//                throw new ResponseStatusException(
//                        HttpStatus.BAD_REQUEST, new Error(&quot;Product has been discontinued &quot;).toString());
//            throw new ResponseStatusException(
//                    HttpStatus.BAD_REQUEST, new Error(&quot;Product existed&quot;).toString());
//        }
<span class="fc" id="L103">        ProductEntity product = updateFromDTO(productDTO, new ProductEntity());</span>
<span class="fc" id="L104">        product.setIsStopped(false);</span>
<span class="fc" id="L105">        return productRepo.save(product);</span>
    }

    public ProductEntity update(ProductDTO productDTO, String id, MultipartFile photo) throws IOException {
<span class="fc" id="L109">        Optional&lt;ProductEntity&gt; productEntityOptional = productRepo.findById(id);</span>
//        if (productEntityOptional.isEmpty())
//            throw new ResponseStatusException(
//                    HttpStatus.NOT_FOUND, &quot;Product not existed&quot;);
//        if (productEntityOptional.get().getIsStopped() == true)
//            throw new ResponseStatusException(
//                    HttpStatus.BAD_REQUEST, &quot;Product has been discontinued &quot;);
<span class="fc" id="L116">        ProductEntity product = updateFromDTO(productDTO, productEntityOptional.get());</span>
//        if (photo != null) {
//            List&lt;String&gt; parsedURL = Arrays.stream(product.getPhotoURL().split(&quot;/&quot;)).toList();
//            amazonS3Service.deleteFile(parsedURL.get(parsedURL.size() - 1));
//            String objectURL = amazonS3Service.updateFile(photo, product.getName() + &quot;_&quot; + photo.getOriginalFilename());
//            product.setPhotoURL(objectURL);
//        }
<span class="fc" id="L123">        return productRepo.save(product);</span>
    }

    public void remove(String id) {
<span class="fc" id="L127">        Optional&lt;ProductEntity&gt; productEntityOptional = productRepo.findById(id);</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">        if (productEntityOptional.isEmpty())</span>
<span class="fc" id="L129">            throw new ResponseStatusException(</span>
<span class="fc" id="L130">                    HttpStatus.NOT_FOUND, new Error(&quot;Product not existed&quot;).toString());</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">        if (productEntityOptional.get().getIsStopped().equals(true))</span>
<span class="fc" id="L132">            throw new ResponseStatusException(</span>
<span class="fc" id="L133">                    HttpStatus.BAD_REQUEST, new Error(&quot;Product has been discontinued&quot;).toString());</span>
<span class="fc" id="L134">        productEntityOptional.get().setIsStopped(true);</span>
<span class="fc" id="L135">        productRepo.save(productEntityOptional.get());</span>
<span class="fc" id="L136">    }</span>

    private ProductEntity updateFromDTO(ProductDTO productDTO, ProductEntity product) {
<span class="fc" id="L139">        mapper.updateProductFromDto(productDTO, product);</span>
//        if (productDTO.getCategoryId() != null) {
//            if (productDTO.getCategoryId().isEmpty()) {
//                product.setCategory(null);
//            } else {
//                Optional&lt;CategoryEntity&gt; category = categoryRepo.findById(productDTO.getCategoryId());
//                if (category.isEmpty()) {
//                    throw new ResponseStatusException(HttpStatus.BAD_REQUEST, new Error(&quot;Category not found&quot;).toString());
//                }
//                product.setCategory(category.get());
//                if (category.get().getIsStopped() == true)
//                    throw new ResponseStatusException(
//                            HttpStatus.NOT_FOUND, &quot;Category has been discontinued &quot;);
//                product.setCategory(category.get());
//            }
//        }
<span class="fc" id="L155">        List&lt;SupplierEntity&gt; supplierEntities = new ArrayList&lt;&gt;();</span>
//        productDTO.getSuppliers().forEach(s -&gt; {
//            Optional&lt;SupplierEntity&gt; supplier = supplierRepo.findById(s);
//            if (supplier.isEmpty()) {
//                throw new ResponseStatusException(HttpStatus.NOT_FOUND, new Error(&quot;Supplier with ID: &quot; + s + &quot; not found.&quot;).toString());
//            }
//            if (supplier.get().getIsStopped())
//                throw new ResponseStatusException(
//                        HttpStatus.NOT_FOUND, new Error(&quot;Supplier has been discontinued &quot;).toString());
//            supplierEntities.add(supplier.get());
//        });
<span class="fc" id="L166">        product.setSuppliers(supplierEntities);</span>
<span class="fc" id="L167">        return product;</span>
    }
    @Transactional
    public List&lt;?&gt; getRevisionsForProduct(String id) {
<span class="fc" id="L171">        Optional&lt;ProductEntity&gt; productEntityOptional = productRepo.findById(id);</span>
<span class="fc bfc" id="L172" title="All 2 branches covered.">        if (productEntityOptional.isEmpty())</span>
<span class="fc" id="L173">            throw new ResponseStatusException(</span>
<span class="fc" id="L174">                    HttpStatus.NOT_FOUND, new Error(&quot;Product not existed&quot;).toString());</span>
<span class="fc" id="L175">        AuditReader auditReader = AuditReaderFactory.get(entityManager);</span>

<span class="fc" id="L177">        AuditQuery query = auditReader.createQuery()</span>
<span class="fc" id="L178">                .forRevisionsOfEntity(ProductEntity.class, true, true)</span>
<span class="fc" id="L179">                .add(AuditEntity.id().eq(id))</span>
<span class="fc" id="L180">                .addProjection(AuditEntity.property(&quot;id&quot;))</span>
<span class="fc" id="L181">                .addProjection(AuditEntity.property(&quot;name&quot;))</span>
<span class="fc" id="L182">                .addProjection(AuditEntity.property(&quot;category_id&quot;))</span>
<span class="fc" id="L183">                .addProjection(AuditEntity.property(&quot;unit&quot;))</span>
<span class="fc" id="L184">                .addProjection(AuditEntity.property(&quot;price&quot;))</span>
<span class="fc" id="L185">                .addProjection(AuditEntity.property(&quot;quantity&quot;))</span>
<span class="fc" id="L186">                .addProjection(AuditEntity.property(&quot;warrantyPeriod&quot;))</span>
<span class="fc" id="L187">                .addProjection(AuditEntity.property(&quot;isStopped&quot;))</span>
<span class="fc" id="L188">                .addProjection(AuditEntity.property(&quot;photoURL&quot;))</span>
<span class="fc" id="L189">                .addProjection(AuditEntity.revisionNumber())</span>
<span class="fc" id="L190">                .addProjection(AuditEntity.revisionType())</span>
<span class="fc" id="L191">                .addOrder(AuditEntity.revisionNumber().desc());</span>

<span class="fc" id="L193">        List&lt;AuditEnversInfo&gt; productAudit = new ArrayList&lt;AuditEnversInfo&gt;();</span>
//        List&lt;Object[]&gt; objects = query.getResultList();
//        for(int i=0; i&lt; objects.size();i++){
//            Object[] objArray = objects.get(i);
//            Optional&lt;AuditEnversInfo&gt; auditEnversInfoOptional = auditEnversInfoRepo.findById((int) objArray[9]);
//            if (auditEnversInfoOptional.isPresent()) {
//                AuditEnversInfo auditEnversInfo = auditEnversInfoOptional.get();
////                ProductDTO product = new ProductDTO(id, (String) objArray[1],  (String) objArray[2], (String) objArray[3], (Long) objArray[4], (Integer) objArray[5], (Integer) objArray[6] , (Boolean) objArray[7], (String) objArray[8]);
//                ProductEntity entity = productRepo.findById((String) objArray[0]).get();
////                List&lt;ProductEntity&gt; products = productRepo.findById(entity.getId());
////                entity.setImportProducts(importProducts);
//                auditEnversInfo.setRevision(entity);
//                productAudit.add(auditEnversInfo);
//            }
//        }
<span class="fc" id="L208">        entityManager.close();</span>
<span class="fc" id="L209">        return productAudit;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>